services:

  app:
    build:
      context: .
      dockerfile: Dockerfile.app
      target: production
    container_name: lumo-bridge-app
    ports:
      - "${PORT}:${PORT}"
    env_file:
      - .env
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - CDP_ENDPOINT=http://browser-dev:9223
    depends_on:
      - browser-dev
    restart: unless-stopped


  # App service - lightweight Node.js app with hot reload
  app-dev:
    build:
      context: .
      dockerfile: Dockerfile.app
      target: development
    container_name: lumo-bridge-app-dev
    ports:
      - "${PORT}:${PORT}"
      - "9229:9229"  # Node.js debugger port
    env_file:
      - .env
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - CDP_ENDPOINT=http://browser-dev:9223
    volumes:
      # Mount source code for live editing and hot reload
      - ./src:/app/src:rw
      - ./package.json:/app/package.json:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      # Persist node_modules (performance optimization)
      - node_modules:/app/node_modules
    depends_on:
      - browser-dev
    restart: unless-stopped
    stdin_open: true
    tty: true

  # Browser service - runs Chromium with CDP enabled (headed mode for dev)
  browser-dev:
    # image: lscr.io/linuxserver/chromium:latest
    build:
      context: .
      dockerfile: Dockerfile.browser
    container_name: lumo-bridge-browser-dev
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - CHROME_CLI=--remote-debugging-address=0.0.0.0 --remote-debugging-port=9222 --remote-debugging-allowed-origins=* --disable-dev-shm-usage
    volumes:
      # Persist browser profile and state
      - ./browser-data:/config
    ports:
      # - "9223:9223"  # CDP endpoint (forwarded via socat)
      - "3001:3001"  # noVNC web interface (access browser GUI)
    shm_size: 2gb
    restart: unless-stopped
    security_opt:
      - seccomp:unconfined
    stdin_open: true
    tty: true

  # Optional: Open WebUI for testing
  open-webui:
    image: ghcr.io/open-webui/open-webui:main-slim
    container_name: open-webui
    ports:
      - "8080:8080"
    environment:
      - OPENAI_API_BASE_URLS=http://app-dev:${PORT}/v1
      - OPENAI_API_KEYS=${API_KEY}
      - ENABLE_OPENAI_API=true
    volumes:
      - open-webui-data:/app/backend/data
    restart: unless-stopped
    depends_on:
      - app-dev


volumes:
  node_modules:
  open-webui-data:
