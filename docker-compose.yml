services:

  app:
    build: .
    container_name: lumo-tamer-app
    ports:
      - "3003:3003"
    volumes:
      - ./config.yaml:/app/config.yaml
      - ./sessions:/app/sessions
    secrets:
      - lumo-vault-key
    environment:
      - NODE_ENV=production
    restart: unless-stopped

  # Browser service - runs Chromium with CDP enabled (headed mode for dev)
  browser:
    # image: lscr.io/linuxserver/chromium:latest
    build:
      context: .
      dockerfile: Dockerfile.browser
    container_name: lumo-tamer-browser
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      # we use port=9221 here, socat in the image will forward 9222 to it
      - CHROME_CLI=https://lumo.proton.me --remote-debugging-address=0.0.0.0 --remote-debugging-port=9221 --remote-debugging-allowed-origins=* --disable-dev-shm-usage
    volumes:
      # Persist browser profile and state
      - ./browser-data:/config
    ports:
      - "9222:9222"  # CDP endpoint (forwarded via socat)
      - "3001:3001"  # noVNC web interface (access browser GUI)
    shm_size: 2gb
    restart: unless-stopped
    security_opt:
      - seccomp:unconfined
    stdin_open: true
    tty: true

  # Optional: Open WebUI for testing
  open-webui:
    image: ghcr.io/open-webui/open-webui:main-slim
    container_name: open-webui
    # Read apiKey from config.yaml at startup and export as OPENAI_API_KEYS env var
    entrypoint: ["/bin/bash", "-c", "export OPENAI_API_KEYS=$(grep 'apiKey:' /app/config.yaml | head -1 | sed 's/.*apiKey: *\"\\{0,1\\}//;s/\".*//') && exec /app/backend/start.sh"]
    ports:
      - "8080:8080"
    environment:
      - OPENAI_API_BASE_URLS=http://10.0.1.5:3003/v1
      - ENABLE_OPENAI_API=true
    volumes:
      # access app config for API key
      - ./config.yaml:/app/config.yaml:ro
      - open-webui-data:/app/backend/data
    restart: unless-stopped

secrets:
  # WARNING: use Docker Swarm or another secrets management tool for production environments
  lumo-vault-key:
    file: ./secrets/lumo-vault-key

volumes:
  open-webui-data:
