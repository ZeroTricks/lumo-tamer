services:

  app:
    build: .
    container_name: lumo-tamer-app
    ports:
      - "3003:3003"
    volumes:
      - ./config.yaml:/app/config.yaml
      - ./sessions:/app/sessions
    secrets:
      - lumo-vault-key
    environment:
      - NODE_ENV=production
    restart: unless-stopped

  # Browser service - runs Chromium with CDP enabled (headed mode for dev)
  browser:
    # image: lscr.io/linuxserver/chromium:latest
    build:
      context: .
      dockerfile: Dockerfile.browser
    container_name: lumo-tamer-browser
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - CHROME_CLI=--remote-debugging-address=0.0.0.0 --remote-debugging-port=9222 --remote-debugging-allowed-origins=* --disable-dev-shm-usage
    volumes:
      # Persist browser profile and state
      - ./browser-data:/config
    ports:
      # - "9223:9223"  # CDP endpoint (forwarded via socat)
      - "3002:3001"  # noVNC web interface (access browser GUI)
    shm_size: 2gb
    restart: unless-stopped
    security_opt:
      - seccomp:unconfined
    stdin_open: true
    tty: true

  # Optional: Open WebUI for testing
  open-webui:
    image: ghcr.io/open-webui/open-webui:main-slim
    container_name: open-webui
    ports:
      - "8080:8080"
    environment:
      - OPENAI_API_BASE_URLS=http://app:3003/v1
      - OPENAI_API_KEYS=
      - ENABLE_OPENAI_API=true
    volumes:
      - open-webui-data:/app/backend/data
    restart: unless-stopped

secrets:
  # WARNING: use Docker Swarm or another secrets management tool for production environments
  lumo-vault-key:
    file: ./secrets/lumo-vault-key

volumes:
  open-webui-data:
