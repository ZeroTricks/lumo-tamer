# Authentication configuration
auth:
  # - browser: token extraction via browser
  # - login: enter Proton credentials via go-proton-api
  # - rclone: paste rclone config
  # See docs/authentication.md
  method: "browser"

  # Encrypted vault for secure token storage (AES-256-GCM)
  # Key is stored in OS keychain (desktop) or Docker secret (containers)
  vault:
    path: "sessions/vault.enc"
    keychain:
      service: "lumo-tamer"
      account: "vault-key"

    # Fallback key file path when OS keychain is unavailable (e.g., Docker, headless servers)
    # WARNING: use keyFilePath with Docker Swarm secrets or another secrets management tool for production environments
    keyFilePath: "/run/secrets/lumo-vault-key"

  # Auto-refresh: automatically refresh tokens before they expire
  autoRefresh:
    # Enable automatic token refresh
    enabled: true
    # Refresh interval in hours (1-24)
    intervalHours: 20
    # Refresh tokens on 401 errors
    onError: true

  # Browser-specific config (only used when method: browser)
  browser:
    # Chrome DevTools Protocol endpoint for remote browser
    cdpEndpoint: "http://localhost:9222"
    # use this if you're running both app and browser docker containers:
    # cdpEndpoint: "http://browser:9222"

  # Login-specific config (only used when method: login)
  login:
    # Path to proton-auth Go binary
    binaryPath: "./dist/proton-auth"
    # Headers to help avoid CAPTCHA - see docs/authentication.md
    appVersion: "macos-drive@1.0.0-alpha.1+rclone"
    userAgent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"

# Test/development configuration
test:
  mock:
    # Enable mock mode: bypass authentication, return simulated Lumo responses
    enabled: false
    # Scenario: success, error, timeout, rejected, toolCall, confusedToolCall, weeklyLimit, cycle
    scenario: "success"

# Shared Logging Configuration (can be overridden in server/cli sections)
log:
  # Levels: trace, debug, info, warn, error, fatal
  level: "info"
  # "stdout" or "file"
  target: "stdout"
  # Used when target is "file"
  filePath: "lumo-tamer.log"
  # Log user/assistant message content (disabled by default to preserve privacy)
  messageContent: false

# Shared Conversations Configuration (can be overridden in server/cli sections)
# Note: In-memory conversation storage is always active regardless of sync settings
conversations:
  # Max conversations to keep in memory (LRU eviction)
  maxInMemory: 100

  # WORKAROUND for clients without conversation_id support (e.g., Home Assistant).
  # Derives conversation ID from the `user` field in the request.
  # Home Assistant sends its internal conversation_id as user, making it unique per chat session.
  # WARNING: May incorrectly merge unrelated conversations with same "user" field. Ignored if `user` is absent.
  deriveIdFromUser: false

  # Sync: persist conversations to Proton servers (requires browser auth)
  sync:
    # Enable syncing to Proton servers
    enabled: false
    # Project name for conversations (created if doesn't exist)
    projectName: lumo-tamer
    # Optional: use specific project UUID instead of name matching.
    # Get the UUID from the URL when your project is loaded in the Web Client:
    # https://lumo.proton.me/u/1/projects/youruuid-looks-like-this>
    # projectId: "uuid"
    # Include system/tool messages in sync
    # WARNING: Setting this to false is experimental:
    # - this may break saved conversation flow (conversations get split or become trees)
    # - not all system messages or commands will be filtered out
    includeSystemMessages: true
    # Auto-sync vs manual /save command
    autoSync: true

# Shared Commands Configuration (can be overridden in server/cli sections)
commands:
  # Enable slash commands (/save, /help, /logout, etc.)
  # When disabled, commands are ignored and treated as regular messages.
  enabled: true

# Server Configuration
server:
  port: 3003
  apiKey: "your-secret-api-key-here"
  apiModelName: "lumo"

  # Enable Lumo's native web_search tool (and other external tools: weather, stock, cryptocurrency)
  enableWebSearch: true

  # Custom tool detection for API clients
  # Enable detection of JSON tool calls in Lumo's responses
  # WARNING: When enabled, Lumo can trigger actions via API clients!
  customTools:
    enabled: false

    # Prefix added to custom tool names to distinguish from Lumo's native tools.
    # Applied to tool definitions sent to Lumo, stripped from tool calls returned to client.
    # Set to "" to disable prefixing.
    prefix: "user:"

    # Search/replace patterns applied to client instructions (case-insensitive regex).
    # Useful for removing or rewriting phrases that may confuse Lumo about tool calling.
    # Each entry: { pattern: "regex", replacement: "text" } - omit replacement to strip.
    replacePatterns:
      - pattern: "(?<=(?:(?:native|custom|internal|external)\\s)?)(?=tool)"
        replacement: "custom "


  instructions:

    # Template for assembling instructions when tools are provided.
    # Variables: {forTools}, {clientInstructions}, {toolsJson}
    template: |
      {forTools}
      
      {clientInstructions}
      
      Below are all the custom tools you can use. Remember, all tools prefixed with `user:` are custom tools and must be called by outputting the JSON to the user.
      
      {toolsJson}

    # Default instructions when no system/developer message is provided in the request
    default: |
      Always answer in plain text. Don't use tables, quote blocks, lists, etc. Be concise.

    # Instructions prepended to tool definitions when tools are provided in the request.
    forTools: |
      === CUSTOM TOOL PROTOCOL ===
      The tools below are CUSTOM tools, prefixed with `user:`.

      IMPORTANT: Custom tools are NOT part of your built-in tool system.
      You MUST call them by outputting JSON as text in a code block to the user, like this:
      ```json
      {"name": "user:example_tool", "arguments": {"param": "value"}}
      ```
      DO NOT try to call custom tools through your internal tool mechanism, it will fail with error:true. If you receive such an error, don't try again with different arguments, but output the JSON as text to the user.
      DO NOT remove the `user:` prefix when calling these tools.

      The user's system will execute them and return results.
      === END PROTOCOL ===

    # Bounce instruction sent when Lumo routes a custom tool through its native tool pipeline.
    # The actual tool call JSON is appended at runtime.
    forToolBounce: |
      You tried to call a custom tool using your built-in tool system, but custom tools must be called by outputting JSON text within a code block. Please output the tool call as JSON, like this:




# CLI Configuration
cli:
  log:
    target: "file"
    filePath: "lumo-tamer-cli.log"

  # Enable Lumo's native web_search tool (and other external tools: weather, stock, cryptocurrency)
  enableWebSearch: true

  # Local actions: code block detection and execution
  localActions:
    # Enable code block detection (```bash, ```read, ```edit, etc.)
    # WARNING: When enabled, Lumo can trigger actions on your machine!
    enabled: false

    # ```read blocks: Lumo can read local files without user confirmation
    fileReads:
      # Enable ```read blocks
      # Note that if this is false, Lumo can still ask to read a file using shell tools (ie. cat)
      enabled: true
      # Max file size in KB. Files larger than this are skipped with an error.
      maxFileSizeKB: 512

    # Executors for code block execution
    # Maps language tag -> [command, ...args]. Code is appended as last arg.
    # Override in config.yaml to restrict or extend
    executors:
      # Unix shells
      bash: ["bash", "-c"]
      sh: ["sh", "-c"]
      zsh: ["zsh", "-c"]
      # Windows shells
      powershell: ["powershell", "-Command"]
      ps1: ["powershell", "-Command"]
      cmd: ["cmd", "/c"]
      # Scripting languages
      python: ["python3", "-c"]
      python3: ["python3", "-c"]
      node: ["node", "-e"]
      javascript: ["node", "-e"]
      js: ["node", "-e"]
      ruby: ["ruby", "-e"]
      perl: ["perl", "-e"]

  instructions:
    default: |
      You are a command line assistant. Your output will be read in a terminal. Keep the formatting to a minimum and be concise.

    # Appended when localActions.enabled=true
    forTools: |
      You can read, edit and create files, and you can execute bash and python commands on the user's machine.
      To execute code, use a code block like ```bash or ```python. The user will be prompted to execute it and the result will be returned to you. Don't explain the user can execute commands, it will be handled automatically. Keep commands simple and safe.
      To read files, use a ```read block with one file path per line. Contents will be returned to you automatically without prompting the user. Example:
      ```read
      README.md
      quickstart.txt
      ```
      To create a new file, use a ```create block. The user will be prompted to confirm. Format:
      ```create
      === FILE: path/to/new-file.txt
      file contents here
      ```
      To edit an existing file, use a ```edit block (one file per block). Read the file first if needed. Format:
      ```edit
      === FILE: path/to/file.txt
      <<<<<<< SEARCH
      exact old text
      =======
      new text
      >>>>>>> REPLACE
      ```
    forToolBounce: |
      You tried to execute an action using your built-in tool system, but these actions must be called by providing a code block. Use for example:
      ```read
      README.md
      ```
      Instead of calling a tool like this:
